# Example Question: "Does the status of latest RFI is draft?"

# query → retrieve cm_tools → (Table level analysis) วิเคราะห์คำถามให้ได้ table ที่เกี่ยวข้องมาก่อน → (Fields level analysis) วิเคราะห์คำถามอีกทีว่าต้องใช้ Field ไหนมาตอบคำถาม
# เวลา user ถามถึง RFI  →  ให้ไปดู business context ก่อน เพื่อวิเคราะห์คำถามในระบบ table ก่อน →  จากนั้น ดึงเอา table ที่เกี่ยวกับ RFI มาให้หมด → วิเคราะห์ในระบบ Field → แล้ว prompt แบบ CoT
# อธิบาย table แยกกับ business context แล้วค่อยหาวิธีีรวมกันอีกทีหนึ่ง


# ให้ llm เลือก table k อันดับ ที่เกี่ยวกับคำถามมากที่สุด จาก context cm_tools พร้อมเหตุผล
# query 
# → tool_router
# → (tool_name, reason)
# → tool_name search from 'cm_tools'
# → (tool_name, reason, RFI contexts)
# → LLM selected top_k related table from RFI contexts
# → (tool_name, reason, top_k RFI contexts, top_k_table_name)
# → top_k_table_name search from 'database_documents'
# → (tool_name, reason, top_k RFI contexts, top_k_table_name, top_k_table_schema)

# document_document.due_date is document due date
# document_submittal.due_date is initiator due date

# document_status   == task_decision  == document_document."status"
# RFI Status        == process_status == document_document."process"
# submittal_status  == process_status == document_submittal."status"
# inspection_status == process_status == document_inspection."status"

# Task Decision of all document (RFI, Submittal, Inspection)
# (document_document."status")
# DOCUMENT_STATUS_INVALID = -1
# DOCUMENT_STATUS_PENDING = 0
# DOCUMENT_STATUS_IN_PROCESS = 1
# DOCUMENT_STATUS_APPROVED = 2
# DOCUMENT_STATUS_APPROVED_AS_NOTE = 3
# DOCUMENT_STATUS_REJECTED = 4
# DOCUMENT_STATUS_REJECTED_AS_NOTE = 5
# DOCUMENT_STATUS_DELETED = 6

# Process Status of all document (RFI, Submittal, Inspection)
# (document_document."process")
# DOCUMENT_PROCESS_DRAFT = 0
# DOCUMENT_PROCESS_REVIEW = 1
# DOCUMENT_PROCESS_OPEN = 2
# DOCUMENT_PROCESS_WAITING_FOR_MANAGER = 3
# DOCUMENT_PROCESS_CLOSED = 4

# Initiator Status of Submittal
# (document_submittal."status")
# INITIATOR_STATUS_PENDING = 0
# INITIATOR_STATUS_APPROVED = 1
# INITIATOR_STATUS_APPROVED_AS_NOTE = 2
# INITIATOR_STATUS_REJECTED = 3
# INITIATOR_STATUS_REJECTED_AS_NOTE = 4
# INITIATOR_STATUS_CHANGE_BIC = 5

# Inspector Status of Inspection
# INSPECTOR_STATUS_PENDING = 0
# INSPECTOR_STATUS_APPROVED = 1
# INSPECTOR_STATUS_APPROVED_AS_NOTE = 2
# INSPECTOR_STATUS_REJECTED = 3
# INSPECTOR_STATUS_REJECTED_AS_NOTE = 4
# INSPECTOR_STATUS_CHANGE_BIC = 5

# Assignnee Status of all document (RFI, Submittal, Inspection)
# ASSIGNMENT_STATUS_PENDING = 0
# ASSIGNMENT_STATUS_APPROVED = 1
# ASSIGNMENT_STATUS_APPROVED_AS_NOTE = 2
# ASSIGNMENT_STATUS_REJECTED = 3
# ASSIGNMENT_STATUS_REJECTED_AS_NOTE = 4
# ASSIGNMENT_STATUS_CHANGE_BIC = 5

# Manager Status
# MANAGER_STATUS_PENDING = 0
# MANAGER_STATUS_APPROVED = 1
# MANAGER_STATUS_APPROVED_AS_NOTE = 2
# MANAGER_STATUS_REJECTED = 3
# MANAGER_STATUS_REJECTED_AS_NOTE = 4
# MANAGER_STATUS_CHANGE_BIC = 5

version: "1.0"

database_docs:
  tables:
    document_document:
      name: "document_document"
      description: >
        document_document is the master table for all document types (RFI, Submittal, Inspection).  
        By itself, document_document refers to an RFI.  
        When joined with document_submittal, it represents a Submittal.  
        When joined with document_inspection, it represents an Inspection.
      fields:
        - id: "[BIGINT] Primary key"
        - deleted: "[TIMESTAMP] Indicates when this object was deleted"
        # - deleted_by_cascade: "[BOOLEAN] Indicates whether this object was deleted through cascade"
        - created_at: "[TIMESTAMP] Date and time when this object was created"
        # - updated_at: "[TIMESTAMP] Date and time when this object was last updated"
        - code: "[VARCHAR(50)] Unique code for this document"
        - title: "[VARCHAR(255)] Title of this document"
        - type: "[INTEGER] ENUM type of this document (0 = RFI, 1 = Submittal, 2 = Inspection)"
        - process: "[INTEGER] ENUM for the process status of each document type (0 = Draft, 1 = Review, 2 = Open, 3 = Waiting for Manager, 4 = Closed)"
        - status: "[INTEGER] ENUM for the task decision of each document type (0 = Invalid, 1 = Pending, 2 = In Process, 3 = Approved, 4 = Approved as Note, 5 = Rejected, 6 = Rejected as Note, 7 = Deleted)"
        - due_date: "[TIMESTAMP] Due date of the document (applies to RFI, Submittal, and Inspection)"
        - schedule_impact: "[DOUBLE PRECISION] Number of days this document impacts the project schedule"
        - cost_impact: "[DOUBLE PRECISION] Amount this document impacts the project cost (default in USD)"
        - drawing_number: "[VARCHAR(255)] Reference drawing number for this document (if any). Used to associate multiple documents with a single drawing"
        - cycle: "[INTEGER] Number of times this document has been revised"
        - is_private: "[BOOLEAN] Indicates whether this document is private"
        - description: "[TEXT] Field for additional information about this document"
        - created_by_id: "[INTEGER] the id of user who created this document. This is a foreign key to auth_user.id (document_document.created_by_id → auth_user.id)"
        - discipline_id: "[BIGINT] the id of discipline of this document. This is a foreign key to company_discipline.id (document_document.discipline_id → company_discipline.id)"
        - location_id: "[BIGINT] the id of location of this document. This is a foreign key to project_location.id (document_document.location_id → project_location.id)"
        - project_id: "[BIGINT] the id of project of this document. This is a foreign key to project_project.id (document_document.project_id → project_project.id)"
        - specification_id: "[BIGINT] the id of specification of this document. This is a foreign key to project_specification.id (document_document.specification_id → project_specification.id)"
        - template_id: "[BIGINT] the id of template of this document. This is a foreign key to document_template.id (document_document.template_id → document_template.id)"
        - updated_by_id: "[BIGINT] the id of user who updated this document. This is a foreign key to auth_user.id (document_document.updated_by_id → auth_user.id)"
        # - order: #TODO: What's is this?
        - received_from_id: "[BIGINT] the id of user who received this document. This is a foreign key to auth_user.id (document_document.received_from_id → auth_user.id)"
        - inspection_test_plan_id: "[BIGINT] the id"
        - responsible_contractor_id: "[BIGINT] the id of responsible contractor of this document. This is a foreign key to company_contractor.id (document_document.responsible_contractor_id → company_contractor.id)"
        - is_recently_rejected: "[BOOLEAN] the recently rejected flag of this document indicates if this document has been recently rejected. This is used to highlight the document in the document list"
        - floor_plan_id: "[BIGINT] the id of floor plan of this document. This is a foreign key to project_floorplan.id (document_document.floor_plan_id → project_floorplan.id)"
      relations:
        - document_document.created_by_id → auth_user.id
        - document_document.discipline_id → company_discipline.id
        - document_document.floor_plan_id → project_floorplan.id
        - document_document.inspection_test_plan_id → inspection_test_plan_inspectiontestplan.id
        - document_document.location_id → project_location.id
        - document_document.project_id → project_project.id
        - document_document.received_from_id → auth_user.id
        - document_document.responsible_contractor_id → company_contractor.id
        - document_document.specification_id → project_specification.id
        - document_document.template_id → document_template.id
        - document_document.updated_by_id → auth_user.id
      enums:
        - type: "0 = RFI, 1 = Submittal, 2 = Inspection"
        - process: "0 = Draft, 1 = Review, 2 = Open, 3 = Waiting for Manager, 4 = Closed"
        - status: "0 = Invalid, 1 = Pending, 2 = In Process, 3 = Approved, 4 = Approved as Note, 5 = Rejected, 6 = Rejected as Note, 7 = Deleted"

    document_submittal:
      name: "document_submittal"
      description: >
        document_submittal is an extension of table::document_document for submittals. 
        It contains additional fields such as document_number, rev, due_date, status, 
        response, response_date, round, cycle, is_latest, created_by_id, document_id, 
        updated_by_id, user_id, and rejected_to. 
        Used for managing and tracking submittal-specific information.
      fields:
        - id: "[BIGINT] Primary key"
        # - deleted: "[TIMESTAMP] Indicates if this object has been deleted"
        # - deleted_by_cascade: "[BOOLEAN] indicates if this object has been deleted by cascade"
        # - created_at: "[TIMESTAMP] the time this object was created"# NOTE: what's different between document_document.created_at and document_submittal.created_at
        # - updated_at: "[TIMESTAMP] the time this object was updated"# NOTE: what's different between document_document.updated_at and document_submittal.updated_at
        - document_number: "[VARCHAR(155)] User-defined document number for this submittal, used to track and identify the submittal document"
        - rev: "[VARCHAR(2)] Revision of this submittal document, uniquely identifying each version of the same document number"
        - due_date: "[TIMESTAMP] Due date set by the submittal’s initiator" #note: when joined with document_document, document_document.due_date refers to the manager’s due date)"
        - status: "[INTEGER] Status of the submittal’s initiator (0 = Pending, 1 = Approved, 2 = Approved as Note, 3 = Rejected, 4 = Rejected as Note, 5 = Change BIC)"
        - response: "[TEXT] Acknowledgment or response message from the initiator who received this submittal"
        - response_date: "[TIMESTAMP] Date and time when the initiator responded to this submittal"
        - round: "[INTEGER] Number of times this submittal has been rejected in the workflow. Each rejection increases the round by 1 and starts a new cycle"
        - cycle: "[INTEGER] Number of times this submittal has been revised"
        # - is_latest: "[BOOLEAN] THIS FIELD IS DEPRECATED. DOES NOT USED ANYMORE"
        - created_by_id: "[INTEGER] the id of user who created this submittal. This is a foreign key to auth_user.id (document_submittal.created_by_id → auth_user.id)"
        - document_id: "[BIGINT] the id of document of this submittal. This is a foreign key to document_document.id (document_submittal.document_id → document_document.id)"
        - updated_by_id: "[INTEGER] the id of user who updated this submittal. This is a foreign key to auth_user.id (document_submittal.updated_by_id → auth_user.id)"
        - user_id: "[INTEGER] the id of initiator of this submittal. This is a foreign key to auth_user.id (document_submittal.user_id → auth_user.id)"
        - rejected_to: "[VARCHAR(20)] the rejected to of this submittal is a enum field to indicate the step that this submittal has been rejected to. (values are: manager, initiator, originator, assignee (integer convertable value indicates what is step in workflow that rejected to))"
      relations:
        - document_submittal.created_by_id → auth_user.id
        - document_submittal.document_id → document_document.id
        - document_submittal.updated_by_id → auth_user.id
        - document_submittal.user_id → auth_user.id
      enums:
        - status: "0 = Pending, 1 = Approved, 2 = Approved as Note, 3 = Rejected, 4 = Rejected as Note, 5 = Change BIC"

    document_inspection:
      name: "document_inspection"
      description: "document_inspection table"
      fields:
        - id: "[BIGINT] Primary key"
        # - deleted: "[TIMESTAMP] Indicates if this object has been deleted"
        # - deleted_by_cascade: "[BOOLEAN] indicates if this object has been deleted by cascade"
        # - created_at: "[TIMESTAMP] the time this object was created"
        # - updated_at: "[TIMESTAMP] the time this object was updated"
        - due_date: "[TIMESTAMP] Due date set by the inspector" #note: when joined with document_document, document_document.due_date refers to the manager’s due date
        - status: "[INTEGER] Status of the inspector (0 = Pending, 1 = Approved, 2 = Approved as Note, 3 = Rejected, 4 = Rejected as Note, 5 = Change BIC)"
        - response: "[TEXT] Acknowledgment or response message from the inspector who received this inspection"
        - response_date: "[TIMESTAMP] Date and time when the inspector responded to this submittal"
        - round: "[INTEGER] Number of times this inspection has been rejected in the workflow. Each rejection increases the round by 1 and starts a new cycle"
        - cycle: "[INTEGER] Number of times this inspection has been revised"
        # - is_latest: "[BOOLEAN] indicates if this inspection is latest"
        - created_by_id: "[INTEGER] the id of user who created this inspection. This is a foreign key to auth_user.id (document_inspection.created_by_id → auth_user.id)"
        - document_id: "[BIGINT] the id of document of this inspection. This is a foreign key to document_document.id (document_inspection.document_id → document_document.id)"
        - updated_by_id: "[INTEGER] the id of user who updated this inspection. This is a foreign key to auth_user.id (document_inspection.updated_by_id → auth_user.id)"
        - form_id: "[BIGINT] the id of form of this inspection. This is a foreign key to project_form.id (document_inspection.form_id → project_form.id)"
        - max_score: "[DOUBLE PRECISION] the max score of this inspection"
        - score: "[DOUBLE PRECISION] the score of this inspection"
        - stat: "[JSONB] the stat of this inspection"
        - response_user_id: "[INTEGER] the id of user who responded this inspection. This is a foreign key to auth_user.id (document_inspection.response_user_id → auth_user.id)"
      relations:
        - document_inspection.created_by_id → auth_user.id
        - document_inspection.document_id → document_document.id
        - document_inspection.form_id → project_form.id
        - document_inspection.response_user_id → auth_user.id
        - document_inspection.updated_by_id → auth_user.id
      enums:
        - status: "0 = Pending, 1 = Approved, 2 = Approved as Note, 3 = Rejected, 4 = Rejected as Note, 5 = Change BIC"

    project_project:
      name: "project_project"
      description: "project_project table"
      fields:
        - id: "[BIGINT] Primary key"
        - deleted: "[TIMESTAMP] Indicates if this object has been deleted"
        # - deleted_by_cascade: "[BOOLEAN] indicates if this object has been deleted by cascade"
        - created_at: "[TIMESTAMP] the time this object was created"
        # - updated_at: "[TIMESTAMP] the time this object was updated"
        - code: "[VARCHAR(155)] Project code"
        - title: "[VARCHAR(155)] Project title"
        - uuid: "[VARCHAR(155)] Project uuid"
        - image: "[VARCHAR(155)] Project image"
        - value: "[DOUBLE PRECISION] Project value"
        - size: "[DOUBLE PRECISION] Project size"
        - description: "[VARCHAR(155)] Project description"
        - start_date: "[TIMESTAMP] Project start date"
        - end_date: "[TIMESTAMP] Project end date"
        - company_id: "[BIGINT] the id of company of this project. This is a foreign key to company_company.id (project_project.company_id → company_company.id)"
        - created_by_id: "[INTEGER] the id of user who created this project. This is a foreign key to auth_user.id (project_project.created_by_id → auth_user.id)"
        - process_id: "[BIGINT] the id of process of this project. This is a foreign key to project_process.id (project_project.process_id → project_process.id)"
        - project_type_id: "[BIGINT] the id of project type of this project. This is a foreign key to project_project_type.id (project_project.project_type_id → project_project_type.id)"
        - updated_by_id: "[INTEGER] the id of user who updated this project. This is a foreign key to auth_user.id (project_project.updated_by_id → auth_user.id)"
        - address: "[VARCHAR(155)] Project address"
        - city: "[VARCHAR(155)] Project city"
        - country: "[VARCHAR(155)] Project country"
        - fax: "[VARCHAR(155)] Project fax"
        - latitude: "[DOUBLE PRECISION] Project latitude"
        - longitude: "[DOUBLE PRECISION] Project longitude"
        - phone: "[VARCHAR(155)] Project phone"
        - postcode: "[VARCHAR(155)] Project postcode"
        - state: "[VARCHAR(155)] Project state"
        - time_zone: "[VARCHAR(155)] Project time zone"
        - zone: "[VARCHAR(155)] Project zone"
        - currency_id: "[BIGINT] the id of currency of this project. This is a foreign key to project_currency.id (project_project.currency_id → project_currency.id)"
      relations:
        - project_project.company_id → company_company.id
        - project_project.created_by_id → auth_user.id
        - project_project.currency_id → project_currency.id
        # - project_project.process_id → project_process.id
        # - project_project.project_type_id → project_project_type.id
        - project_project.updated_by_id → auth_user.id
      enums:

    company_company:
      name: "company_company"
      description: "company_company table"
      fields:
        - id: "[BIGINT] Primary key"
        - deleted: "[TIMESTAMP] Indicates if this object has been deleted"
        # - deleted_by_cascade: "[BOOLEAN] indicates if this object has been deleted by cascade"
        - created_at: "[TIMESTAMP] the time this object was created"
        # - updated_at: "[TIMESTAMP] the time this object was updated"
        - code: "[VARCHAR(155)] Company code"
        - title: "[VARCHAR(155)] Company title"
        - address: "[VARCHAR(155)] Company address"
        - logo: "[VARCHAR(155)] Company logo"
        - subtitle_color: "[VARCHAR(155)] Company subtitle color"
        - title_color: "[VARCHAR(155)] Company title color"
        - uuid: "[VARCHAR(155)] Company uuid"
        - watermark: "[VARCHAR(155)] Company watermark"
        - project_amount: "[DOUBLE PRECISION] Project amount"
        - storage_usage: "[DOUBLE PRECISION] Storage usage"
        - user_amount: "[DOUBLE PRECISION] User amount"
        - company_limit_id: "[BIGINT] the id of company limit of this company. This is a foreign key to company_company_limit.id (company_company.company_limit_id → company_company_limit.id)"
      relations:
        - company_company.company_limit_id → company_company_limit.id
      enums:
      